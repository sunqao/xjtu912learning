# 数据结构（13）：查找 - B/B+树

`B/B+`树其实是对二叉搜索树(BST)的扩展，下面所有内容来自下面这个博客的整理（真的太详细了

[B树和B+树的插入、删除图文详解 - nullzx - 博客园 (cnblogs.com)](https://www.cnblogs.com/nullzx/p/8729425.html)

## B树（B-树）

它是一颗多路平衡查找树，我们描述一颗`B`树的时候应该指定阶数，阶数表示了一个结点最多有多少个孩子结点，阶数为`2`的就是常见的二叉搜索树

### **定义**

1. 每个结点最多有`m - 1`个关键字
2. 根结点最少有`1`个关键字
3. 非根结点最少有`math.ceil(m / 2) - 1`个关键字，`(Math.ceil指上取整)`
4. 每个结点的关键字都按照从小到大的顺序排列，每个关键字的左子树的关键字都小于它，右子树中的所有关键字都大于它
5. 所有叶子结点都位于同一层，根结点到任何叶子结点的长度相同

下面是一颗`m = 4`的`B`树，每个结点中存储了关键字`key`和关键字对应的数据`value`，以及孩子结点的指针，**我们将一个key和其对应的data称为一个记录**。**但为了方便描述，除非特别说明，后续文中就用key来代替（key, value）键值对这个整体**，在数据库中我们将B树（和B+树）作为索引结构，可以加快查询速速，此时B树中的key就表示键，而data表示了这个键对应的条目在硬盘上的逻辑地址。

![clip_image002](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232634472-395289491.png)

### B树的插入操作

插入操作是指插入一条记录，即（key, value）的键值对。如果B树中已存在需要插入的键值对，则用需要插入的value替换旧的value。若B树不存在这个key,则一定是在叶子结点中进行插入操作。

1）根据要插入的key的值，找到叶子结点并插入。

2）判断当前结点key的个数是否小于等于m-1，若满足则结束，否则进行第3步。

3）以结点中间的key为中心分裂成左右两部分，然后将这个中间的key插入到父结点中，这个key的左子树指向分裂后的左半部分，这个key的右子支指向分裂后的右半部分，然后将当前结点指向父结点，继续进行第2步。

下面以5阶B树为例，介绍B树的插入操作，在5阶B树中，结点最多有4个key,最少有2个key

------

a）在空树中插入39

![clip_image002[4]](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232637766-945625689.png)

此时根结点就一个key，此时根结点也是叶子结点

------

b）继续插入22，97和41

![clip_image004](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232641280-907189483.png)

根结点此时有4个key

------

c）继续插入53

![clip_image006](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232644645-1214967776.png)

插入后超过了最大允许的关键字个数4，所以以key值为41为中心进行分裂，结果如下图所示，分裂后当前结点指针指向父结点，满足B树条件，插入操作结束。当阶数m为偶数时，需要分裂时就不存在排序恰好在中间的key，那么我们选择中间位置的前一个key或中间位置的后一个key为中心进行分裂即可。

![clip_image008](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232701452-1205325216.png)

这里的当前指针指向父节点的意思是分裂后`41`这个键值对插入到父节点中，此时考察父节点，如果父节点的键值对个数超过了`4`，那么重复上述操作，继续分裂，一直到满足`B`树的定义

------

d）依次插入13，21，40，同样会造成分裂，结果如下图所示。

![clip_image010](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232716269-1873273300.png)

------

e）依次插入30，27, 33 ；36，35，34 ；24，29，结果如下图所示。

![clip_image012](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232719931-1845157889.png)

-----

f）插入key值为26的记录，插入后的结果如下图所示。

[![clip_image014](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232724001-1518264552.png)](https://images2018.cnblogs.com/blog/834468/201804/834468-20180406232722072-2101780219.png)

当前结点需要以27为中心分裂，并向父结点进位27，然后当前结点指向父结点，结果如下图所示。

[![clip_image016](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232732844-330586131.png)](https://images2018.cnblogs.com/blog/834468/201804/834468-20180406232727483-1657363165.png)

进位后导致当前结点（即根结点）也需要分裂，分裂的结果如下图所示。

[![clip_image018](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232737701-1115673096.png)](https://images2018.cnblogs.com/blog/834468/201804/834468-20180406232735788-403419538.png)

分裂后当前结点指向新的根，此时无需调整。

------

g）最后再依次插入key为17,28,29,31,32的记录，结果如下图所示。

[![clip_image020](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/834468-20180406232748270-1888091858.png)](https://images2018.cnblogs.com/blog/834468/201804/834468-20180406232742794-343445338.png)

------

在实现B树的代码中，为了使代码编写更加容易，我们可以将结点中存储记录的数组长度定义为m而非m-1，这样方便底层的结点由于分裂向上层插入一个记录时，上层有多余的位置存储这个记录。同时，每个结点还可以存储它的父结点的引用，这样就不必编写递归程序。

一般来说，对于确定的m和确定类型的记录，结点大小是固定的，无论它实际存储了多少个记录，因为类型确定的话插入记录只会插入到每个结点的空闲位置处。但是分配固定结点大小的方法会存在浪费的情况，比如key为28,29所在的结点，还有2个key的位置没有使用，但是已经不可能继续在插入任何值了，因为这个结点的前序key是27,后继key是30,所有整数值都用完了。所以如果记录先按key的大小排好序，再插入到B树中，结点的使用率就会很低，最差情况下使用率仅为50%，排好序后再插入记录，当结点满了之后进行分裂，分裂出去的新的结点的空间很容易浪费

### B树的删除操作

删除操作是指，根据key删除记录，如果B树中的记录中不存对应key的记录，则删除失败。

1）如果当前需要删除的key位于非叶子结点上，则用后继key（这里的后继key均指后继记录的意思）覆盖要删除的key，然后在后继key所在的子支中删除该后继key。此时后继key一定位于叶子结点上，这个过程和二叉搜索树删除结点的方式类似。删除这个记录后执行第2步

2）该结点key个数大于等于`Math.ceil(m/2)-1`，结束删除操作，否则执行第3步。

3）如果兄弟结点key个数大于`Math.ceil(m/2)-1`，则父结点中的key下移到该结点，兄弟结点中的一个key上移，删除操作结束。

否则，将父结点中的key下移与当前结点及它的兄弟结点中的key合并，形成一个新的结点。原父结点中的key的两个孩子指针就变成了一个孩子指针，指向这个新结点。然后当前结点的指针指向父结点，重复上第2步。

有些结点它可能即有左兄弟，又有右兄弟，那么我们任意选择一个兄弟结点进行操作即可。

下面以5阶B树为例，介绍B树的删除操作，5阶B树中，结点最多有4个key,最少有2个key
