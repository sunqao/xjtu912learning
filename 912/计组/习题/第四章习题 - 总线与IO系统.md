# 第四章习题-总线与IO系统

## 例 4.1 

![image-20240814192528098](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240814192528098.png)

**（1）**

而带宽是总线理论数据传输的最大值，所以一秒的所有时钟周期中总线全部传送数据，**也就是一个总线周期中的所有时钟周期都传输数据，这就是带宽了**，也就是1s能够传输数据的最大值

总线的时钟频率就是一秒有多少个总线时钟周期

每个时钟周期都传输数据，于是总线就是时钟频率乘位数了

带宽：`F = f * D = 33 M * 32 = 132 `MB/s 注意这里的M表示10^6的意思

但是总线并不是1s的每个时钟周期中都传输数据的，总线的一次完整的操作有四个阶段：

（1）申请分配，（2）寻址，（3）数据传送，（4）结束

以同步通信为例，这四个阶段构成了一个总线周期，包含了四个总线时钟周期，也就是说四个时钟周期中总线才传送一次数据，**也就是一个总线周期传送一次数据**，所以我们得求1s中有多少个总线周期，然后1s中的总线的周期个数乘32bit得到数据传输率

总线时钟周期：`T = 1 / f = 1/33M `s 注意这里的M表示10^6的意思

总线周期：`T' = 4T = 4 / f = 4 / 33M `s

1s中总线周期的个数：`1s/T’ = f / 4 = 33M / 4`个

实际数据传输率：`P = D * f / 4 = 32bit * (33M / 4) = 33`MB/s  注意这里的M表示10^6的意思

其实就是带宽除以4

**（2）**

总线时钟频率和带宽增加一倍

那么带宽有：`F = f * D = 33M * 2 * 32 * 2 = 528` MB/s

总线时钟周期：`T = 1 / f = 1 / (33MHz * 2)`s

总线周期：`T' = 2 / f = 2 / (33MHz * 2) = 1 / 33M`s

1s中的总线周期个数：`f / 2 = 33M`个

数据传输率：`D * f / 2 = 64 * 33M = 264 `MB /s 这里的M都是10^6的意思

**总线带宽是1s中的所有时钟周期都传输数据，即一个总线周期中的所有时钟周期都传输数据，实际数据传输率是一个总线周期只传一次数据，假设一个总线周期有k个时钟周期，所以实际数据传输率，就用带宽除以k即可**

## 例 4.2

![image-20240914193145897](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240914193145897.png)

**（1）**

这里的缓存容量，就是VRAM的容量

通常字符是以ASCII存放在VRAM中的，一个字符就占一个字节，因此VRAM中的一个存储单元就是一个字节，最大存储容量就是整个屏幕的整个所有字符，即：
$$
64 * 25 *8b = 12800b = 1600B
$$
**（2）**

ROM中存放的是整个字符集，一个字符在屏幕中占据的所有的点阵就表示ROM中的一个二进制的位

每个字符占据7 * 8的点阵，但是还有一像素的字间间隔，注意在这一章中像素点阵的7 * 8是7列8行 即 列*行，而不是一般的程序语言中的行 * 列，所以一个字符占据的点阵应该是8（列） * 8（行）

这个字符集有95个字符，所以ROM的大小至少为：
$$
95 * 8 * 8b= 760B
$$
**（3）**

显示是整个屏幕字符的ASCII码

**（4）**

缓存中的一个字符的地址构成是：
$$
字符所在的行号 * 每行的字符数 + 字符所在的列号
$$
屏幕中的字符显示是从上到下，从左到右显示的

因此VRAM中字符对应的地址也是从小到大与屏幕中的字符一一对应

**（5）**

**点计数器，其模是窗口的大小，在这里就是 7 + 1 = 8**

字计数器，其模是一行所显示的字数加上水平回扫的时间，计算的时候就用一行字符周期的个数代表

这道题目中的点频是14.896MHz，因此扫描一像素点的时间就是$T_点 = \frac{1}{14.896MHz}$

一个字符窗口的行长度是8因此扫描一个字符的长度的时间就是$T_字\frac{8}{14.896MHz}$

同理扫描一行像素点的时间就是$T_{行像素} = \frac{1}{24.5kHz}$

所以扫描一行像素点所扫描的字符的个数，也就是周期的个数就是：
$$
\frac{T_{行像素}}{T_字} = \frac{14.896MHz}{24.5KHz * 8} = 76个
$$
**所以字计数器的模就是76**

行计数器的模，行计数器加一就表示电子束扫描完了一行的像素点，其扫描完成计数达到模就表示电子束扫描完了一排的字符，所以这里得加上行间距，**因此行计数器的模就是字符窗口的高度，就是8 + 6 = 14**

排计数器加一表示扫描完了一排的字符，排计数器达到模就意味着电子束扫描完了整个屏幕，所以排计数器的模就是屏幕的字符的排数

但是排计数器模还得加上电子束垂直回扫的时间，所以这里用扫描一个屏幕时间中扫描的排的周期的个数代替

扫描完一个屏幕的时间就是帧的周期，即$T_{屏幕} = \frac{1}{50}$

行频率，即可以得到扫描一行的像素点的时间是$T_{行像素} = \frac{1}{24.5kHz}$

一排的字符有14行，因此扫描一排的字符的时间就是$T_{排} = \frac{14}{24.5KHz}$

所以扫描完整个屏幕所具有的排的周期个数就是：
$$
\frac{24.5K}{50 * 14} = 35
$$
因此排计数器的模就是35

## 例 4.3

![image-20240916160431890](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240916160431890.png)

波特率其实就是数据的传送速率，也就是单位时间中传送的二进制位的大小

比特率跟波特率类似，不过是有效数据的传送速率，即单位时间中传送的有效二进制位的大小

数据帧就是一串完整的数据格式，包括起始位，数据位，校验位等等，其中数据位是有效二进制位，其他的都不是有效位，比特率只用算有效二进制位，但是波特率需要算一个完整的数据帧

这道题目中，一帧有10位，因此波特率就是：
$$
10b * 120 帧/s = 1200 b/s = 1200Baud
$$
一帧有4个有效位，所以比特率就是：
$$
7 * 120 帧/s = 840 b/s
$$

## 例 4.4

![image-20240922153644844](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240922153644844.png)

算这种问题，统一将1s中的总的时钟周期个数当作总的CPU时间所包含的时钟个数

一次查询需要两条指令

对于键盘和硬盘，每次查询所需要的时钟周期个数为：
$$
2 * 5 = 10
$$
对于键盘，1s查询5次，因此1s总的用于查询的时钟周期个数为50个

因此键盘的查询占CPU时间的比率就是：
$$
\frac{50}{50M} * 100 \% = 0.001\%
$$
对于硬盘由于每次查询一次交换一个字节，而传输率是5MB/s，因此1s查询了5M次，所以1s中CPU用于查询的时钟周期个数为50M个

因此硬盘的查询占CPU的时间的比率就是：
$$
\frac{50M}{50M} * 100 \% = 100 \%
$$
这显然是不可能的，CPU不可能将全部的时间全用于硬盘，所以硬盘是不会采用查询方式进行数据交换控制的

## 例 4.5

![image-20240922155722331](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240922155722331.png)

这里的数据传送就是中断时间，准备时间就是CPU的1s中的总时间总CPU时间，同上一题一样，这里同样可以直接用时钟周期个数来做，这里1s中所包含的CPU时钟周期的个数还是作为CPU时间所包含的时钟周期的个数

首先是一次中断占用的时钟周期个数：

$$
(8 + 2) * 5 = 50
$$

用户是5键/s可以认为是键盘每秒中断5次，因此键盘每1s中断所占的时钟周期个数就是50 * 5 = 250个

因此1s中键盘的中断所占用CPU的时间比率就是（1sCPU有50M个时钟周期）：

$$
\frac{250}{50M} * 100 \% = 0.0005\%
$$

对于硬盘，中断一次交换一个字节，而数据传输率是5MB/s，因此每秒中断5M次

所以1s中键盘中断所占用的时钟周期个数就是：

$$
5M * (8 + 2) * 5
$$

因此硬盘在1s中的CPU的比率就是：

$$
\frac{5M * 50}{50M} * 100\% = 500\%
$$

可以看到CPU在硬盘数据传送时间远远超过准备时间，所以CPU不能采用中断的方式与硬盘进行数据交换，否则会造成数据丢失

## 例 4.6

![image-20240923154238573](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923154238573.png)

**（1）**

一般的优先级顺序就是响应的优先级顺序，同时屏蔽字也按照这样设置即可：

![image-20240923155044386](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923155044386.png)

然后画出处理的程序图，这个图的意思就是在最开始的时候五个中断请求同时到来，但是由于屏蔽字和优先级的顺序一样，所以CPU就先执行A的程序（图中灰色曲线）然后执行完毕之后再执行B，接着一直将E的程序执行完毕再返回

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923155211392.png" alt="image-20240923155211392" style="zoom:50%;" />

**（2）**

这里的中断处理次序其实就决定了屏蔽字的设置，B的处理次序在E的前面，就说明E在B的位置处的屏蔽字应该为0，表示当CPU执行E的中断服务程序的时候不能阻挡B的中断，所以屏蔽字的设置如下：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923160621537.png" alt="image-20240923160621537" style="zoom:67%;" />

当这五个中断同时到来的时候先是处理完B，接着处理E，然后处理C，然后处理A，最后处理D，如下图所示，下图中的小横线其实也可以不用画：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923160918243.png" alt="image-20240923160918243" style="zoom:50%;" />

## 例 4.7

![image-20240923161850924](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923161850924.png)

这里其实是例4.5，CPU主频是50MHz，硬盘的数据传输率是5MB/s

这里还是使用时钟周期来做，1s当作CPU时间，1s中有50M个时钟周期

一次DMA操作CPU的开销为500个时钟周期

硬盘的传输速率是5MB/s，而一次DMA传送5000B数据，所以1s中有1000次DMA操作，因此1s中CPU用于DMA的总的时钟周期个数就是：
$$
500 * 1000个
$$
所以DMA操作占CPU时间的比率为：
$$
\frac{500000}{5000000} * 100\% = 10 \%
$$

## 例 4.8

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240923175058825.png" alt="image-20240923175058825" style="zoom: 50%;" />



**（1）**

这里还是将1s当作整个CPU时间，还是使用时钟周期来做

一次中断所需的时钟周期个数为：$(18 + 2) * 5 = 100$

一次中断传输数据4B，1s传输0.5MB的数据，因此1s应该中断：
$$
\frac{0.5M}{4} = 0.125 * 10^6次
$$
所以1s中用于中断的总的CPU时钟个数为：
$$
12.5 * 10^6个
$$


因此CPU用于外设占整个CPU时间比率为：
$$
12.5*10^6 / 500 *10^6  \%= \frac{12.5}{500} \%= 2.5\%
$$
**（2）**

一次DMA的所占用CPU的时钟周期个数为：500个

1次DMA传送数据5000B，1s传送5MB个，所以1s有1000次DMA操作

因此1s中用于DMA的CPU时钟周期个数为：500000个

所以DMA方式CPU用于外设占总的CPU时间的比率就是：
$$
\frac{500000}{500000000} * 100\% = 0.1\%
$$

## 4.1 总线主模块和从模块

![image-20240925161042495](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240925161042495.png)

![image-20240925161230635](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240925161230635.png)

## 4.2 总线传送信息的过程

![image-20240925161310785](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240925161310785.png)

![image-20240925161401170](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240925161401170.png)

时序关系图不要求掌握

## 4.3 总线带宽和数据传输率

![image-20240926161644755](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240926161644755.png)

总线带宽是指单位时间内总线上可以传输的最大数据量，计算公式：
$$
总线频率 * 总线宽度（字节数）
$$
单位是MB/s

注意根据例4.1，总线频率就是每秒使用总线多少次，但是不是每次都在传输数据，一个总线周期可以包含多个总线时钟频率，一次总线周期传输一次数据，所以实际的数据传输率应该用总线周期来计算；不过在这题中的总线周期与总线时钟周期相等，这里的带宽就是数据传输率

总线带宽：
$$
70MHz * 8B = 560 MB/s
$$
总线数据传输率：
$$
560MB/s
$$

## 4.4 总线带宽和数据传输率

![image-20240926162520440](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240926162520440.png)

**（1）**

总线带宽，就是总线的所有时钟周期都传输数据，是数据传输率的最大值

总线数据传输率，就是总线的一次周期传输一次数据，总线周期可以包含多个总线时钟周期

总线时钟频率，就是1s使用了总线多少次，假如每次都传输数据，那其与总线带宽乘起来就是1s传输数据的量，就是带宽了

当然并不是每次都传输数据，比如这题中一个总线周期包含三个时钟周期，这就意味着3个时钟周期才传输一次数据，所以实际的数据传输率就是总线带宽除以3

**总线带宽：**
$$
33MHz * 4B = 132 MB/s
$$
**数据传输率：**
$$
132 / 3 = 44 MB/s
$$
**（2）**

**总线带宽：**
$$
66MHz * 8 B = 528MB/s
$$
**数据传输率：**
$$
528  / 2MB/s = 264 MB/s
$$

## 4.5 异步通信和同步通信

![image-20240928163815145](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240928163815145.png)

同步通信是一个总线周期中的所有操作（CPU发送地址，发送读命令，发送数据等）根据统一的时钟周期进行，哪个时钟周期进行哪个操作是固定的，比如一个总线周期被划分为四个时钟周期，在第一个时钟周期CPU发送地址，第二个时钟周期发送读命令，第三个时钟周期主存给CPU发送数据等等

异步通信是主模块和从模块采用应答的方式来相互联络，即主模块要等待从模块的回答信号后才能撤销自己发出的信号；异步通信的模块按照自己的使用实际时间使用总线

所以这道题的答案如下：

![image-20240928164740140](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240928164740140.png)

## 4.6 异步通信和同步通信，异步通信的分类

![image-20240928164919907](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240928164919907.png)

![image-20240928164940953](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240928164940953.png)

这里画图不要求掌握

## 4.7 半同步通信

![image-20240929163010901](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240929163010901.png)

**（1）**

半同步通信是同步通信和异步通信结合的一种通信方式；

它以同步通信为基础，可以像同步通信那样由统一的时钟控制，同时可以像异步通信那样，允许各个部件传输的时间不一致

它保留了同步通信简单的特点，又具有异步通信的灵活性

**（2）**

半同步通信在正常总线通信双方的时间协调方式与同步通信一样，一个总线周期的操作根据统一的时钟周期进行；但是对于某些特别慢的模块，它可以插入若干个等待时钟周期来延长总线周期，并增加一条等待状态线/WAIT来控制是否进入等待状态，它通过检测等待信号的有无来判断是否加入等待始终周期来进入等待状态，从而实现双方在时间上的协调

也就是说同步通信的总线周期是固定的，中间分为几个时钟周期，到了什么时间就应该做什么事；但是半同步通信通过检测等待信号在一个总线周期中加入几个等待周期从而改变总线周期的长度，这样显然更灵活一些

## 4.8 总线仲裁 + 集中式总线控制

![image-20240929164026733](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240929164026733.png)

这道题目是死的，直接背会即可

![image-20240929164047087](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240929164047087.png)
