# 第三章 - 存储器

存储器用于存放程序以及与程序有关的的各类数据，主存储器是存储系统的核心，其用来存储计算机运行期间所需的程序和数据，CPU可以直接对齐进行控制和访问

# 3.1 主存储器概述

## 3.1.1 存储器的分类

存储器是计算机系统中的记忆设备，用来存放程序和数据

### 存储器按在计算机系统中的作用分类

**（1）内部存储器**

内部存储器，简称内存，是一种可以直接和CPU交换数据的存储器，内存包括高速缓存存储器Cache和主存储器（简称主存）

主存主要放的是当前CPU正在执行的程序和数据；Cache是用来解决主存和CPU之间的速度差异的，Cache中的内容都是主存的副本，因此内存的容量只取决于主存的大小，与Cache的大小无关

**（2）外部存储器**

也成为辅助存储器，简称辅存，用来存放大量的，暂时不运行的数据和程序，以及一些需要永久保存的数据；外存可以当作内存的后援储存器

**（3）离线存储器**

也成为备份存储器，主要对在线的数据进行备份

**（4）控制存储器**

控制存储器称为微程序存储器，其用于在微程序控制的计算机中存放微程序，控制存储器位于CPU的内部

### 存储器按存储介质分类

存储介质就是存储器中存放信息的物理单元，作为存储器的物理介质其必须有两种区别明显的物理状态

**（1）半导体存储器**

用半导体器件来存取数据，体积小，功耗低，速度快，常用作内存

**（2）磁表面存储器**

用磁层来存取信息，用磁层依附的物质形状来命名，容量大，速度慢，价格低，非电易失，常用作外存

**（3）光盘存储器**

用磁光材料作为存储介质，利用激光进行信息的存取，非电易失，容量大，耐用性好，可靠，互换性强

### 存储器按存取方式分类

**（1）随机存储器（RAM，Random Access Memory）**

随机存储器中任何单元的内容都能被随机存取，并且存取时间与存取单元的物理位置无关

RAM可以分为动态随机存储器（DRAM），和静态随机存取器（SRAM）两种

其中DRAM中存储的信息如果长时间不访问会发生变化，因此需要定时刷新来维持信息的稳定；而SRAM在加电的情况下所存储的信息可以保持稳定



**（2）只读存储器（ROM，Read Only Memory）**

ROM采用的存取方式也是随机存取，但是ROM在正常工作的时候只能读不能写，其写入需要特殊手段进行，其最大的特点就是非易失性和高可靠性，因此ROM通常作为主存的一部分用于存放系统程序和各种固件

按照写入的方式不同，ROM可以分为

**i 可编程ROM，即PROM（Programmable ROM）**

可以进行一次编程写入

**ii 可擦除可编程ROM，即EPROM（Erasable Programmable ROM）**

可以借助紫外线或其他方式进行多次擦除和编程

**iii 电可擦除可编程ROM，即EEPROM（Electrical Erasable Programmable ROM）**

其与EPROM的区别在于擦除的过程中，不需要借助紫外线和其他方式



**（3）顺序存储器（SAM，Sequential Access Memory）**

顺序存储器中的读写完全按照其在存储介质中的顺序进行，因此在顺序存储器中信息的存取与信息所在的物理位置有关；顺序存储器的读写操作只能顺序的按数据所在的物理位置进行，因此这种存储器的平均存取速度很慢；磁带是典型的顺序存储器



**（4）直接存储存储器（DAM，Direct Access Memory）**

其工作原理与SAM类似，其读写操作分为两步，第一步快速定位到信息所在的一个区域，然后再这个小区域中按照顺序对信息进行准确定位，它的速度位于RAM和SAM之间，也被称为半顺序存储器；磁盘存储器和光盘存储器是典型的DAM



**（5）相联存储器（Associative Memory，AM）**

前面的存储器都是按地址访问存储单元的，但是相联存储器是一种不根据地址而是根据存储内容来进行存取的存储器，可以实现快速地查找快表。既可以按照地址寻址也可以按照内容寻址（通常是某些字段），为了与传统寄存器作区别，称为按内容寻址的存储器。

也就是它可以根据CPU给出的关键字与存储单元中的相应信息进行比较，定位到与关键字匹配的存储单元之后将此单元中的信息取出



以上就是存储器的分类了，目前主存储器主要采用半导体器件作为存储介质，下面来介绍一下半导体存储器的分类

### 半导体存储器的分类

**（1）按制造工艺进行分类**

**i 双极型存储器**

主要由TTL晶体管组成，工作速度快，集成度低，功耗大，价格高，通常用作高度缓存器

**ii 金属氧化物半导体存储器**

也就是MOS型存储器，其可以用来制造多种半导体存储器件，其集成度高，功耗低，价格低，速度比双极型慢，主存储器通常就是由MOS型的存储器构成的

**（2）按信息的可保存分类**

**i 电易失型存储器**

也就是断电后数据丢失，大多数的RAM属于这种存储器

**ii 非电易失型存储器**

断电后的数据保存，ROM就是这种存储器，也有一小部分的RAM属于这种

通常主存就是由ROM和RAM组成的，ROM的内容只能读不能写，断电后信息保存，因此就存放一些系统程序；RAM可读可写，断电后信息丢失，于是就存放一些系统运行过程中的用户数据；RAM和ROM共享主存空间，ROM一般占据较小的主存空间，RAM占据了大多数的主存空间

### RAM存储器的分类

RAM存储器按照其工作方式的不同可以分为以下三类

**（1）静态随机存储器（SRAM）**

SRAM的存储电路由MOS管触发器构成，用触发器的导通和截止状态来表示信息0和信息1，其速度快，信息稳定，不需要刷新电路（关于刷新后文细嗦）；但是集成度低，功耗大，成本高，在计算机系统中，SRAM常用于小容量的高速缓存器

**（2）动态随机存储器（DRAM）**

其利用MOS管的栅极分布电容的充放电来保存信息，其集成度高，功耗低，价格便宜，但是存在漏电，因此必须定时刷新来保证数据不丢失，主存储器通常由DRAM组成

**（3）非易失性存储器（NVRAM，Non Volatile RAM）**

在正常工作的时候NVRAM与SRAM的功能相同，可以随机读写，但是在发生停电等突然事件的时候它可以将SRAM中的信息保存到EEPROM（电可擦除可编程只读存储器）中，使得信息得到自动保护，NVRAM一般用于保护存储系统中的重要信息

## 3.1.2 存储器的层次结构

冯诺伊曼的计算机系统以存储器为中心的结构；计算机要求存储器，速度快，容量大以及价格低，但是这三者通常是矛盾的，为了解决这三者之间的矛盾，一个多层次的存储系统应运而生

剩下的内容比较简单，这里就不多说了

# 3.2 主存储器

## 3.2.1 主存储器的组成

主存储器由存储单元组成的存储体和一组控制电路组成，如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240801192857149.png" alt="image-20240801192857149" style="zoom:67%;" />

下面来一一介绍上述单元

### 存储体

存储体是存储单元的集合用来存放二进制信息；不过为了信息交换的效率，主存与计算机系统中的其他部件交换信息的时候不是以二进制的形式进行的，而是将若干个存储元（一个二进制位）组成一个存储单元，存储单元中的二进制信息被部分或完整的写入或读出

所以每个存储单元都有自己的独立地址，存储单元的位数（即存储字长）是字节的整数倍；一个存储器的就是由这样很多的存储单元组成的

### 寻址系统

寻址系统由驱动器，译码器，以及MAR（主存地址寄存器，用来保存数据传输到的地址以及数据来源的地址）组成，地址译码器接收到来自MAR的n位地址后进行译码，经过译码和驱动之后可以形成$2^n$种地址选择信号，每次选中一个存储单元，就可以对齐进行读或者写操作

每一条译码线都要与其所控制的存储单元相连，驱动器就是为了提高译码线的负载能力而设置的；地址译码线的输出端接入到驱动器的输入端，驱动器的输出端接到所有存储单元

### 读写系统

读写系统由读写电路以及MDR组成，MDR用来缓存CPU发过来的数据，或从主存种读到的数据，读写电路接到CPU的读或者写信号之后产生存储器内部的读写信号，将指定地址单元的数据读出送到MDR种供CPU使用，或者将来自CPU的已经写入到MDR的数据放入存储器的指定存储单元种

### 控制电路

控制电路根据CPU发来的读写命令产生存储器各个部件的时序控制信号

### 读写操作实例

在进行读操作的时候

（1）CPU首先在地址总线上给出访问的存储单元的地址

（2）主存的寻址系统对该地址进行译码，并通过驱动器选中指定的存储单元

（3）CPU在控制总线上发出读的命令

（4）主存的读写控制电路将存储单元中存放的数据发送到数据总线上，并通过数据总线送到CPU中

在进行写操作的时候

（1）CPU首先在地址总线上给出访问的存储单元的地址

（2）主存的寻址系统对该地址进行译码，并通过驱动器选中指定的存储单元

（3）CPU将需要写入的数据发送到数据总线上

（4）CPU在控制总线上发出写的命令，主存的读写控制电路将数据总线上的数据写入到指定的存储单元中

一般而言，存储器的芯片采用M * N位来描述其容量，N表示存储器芯片中每个存储单元的字长（称为片字长），存储单元是最小可寻址单位，M表示存储单元的个数；片字长一般取1, 4, 8, 16...k位，每一个存储单元都由存储体中的k位组成

### 寻址系统译码器译码的方式

所谓译码方式，其实就是寻址系统的译码器得到存储单元的地址后怎么通过译码器连接确定存储单元的过程，这里有两种方式，线选法确定存储单元和重合法确定存储单元

**（1）线选法**

线选法其实就是译码器得到存储单元的地址后输出的字线直接连接到对应的存储单元中，直接将这个地址处的存储单元全部取出

我们假设有一个1K * 8位的存储器芯片，其采用的是1024 * 8的存储矩阵，于是我们知道存储单元的个数应该为$2^{10}$个，所以地址位数应该为10位，因此线选法的硬件电路如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803165010102.png" alt="image-20240803165010102" style="zoom:67%;" />

上图中一个存储元的左边一个数字是其所在存储单元的地址，右边是其在一个存储单元中的第几位，一个字线对应一个存储单元，一个字线对应一套驱动电路，因此就有1024套驱动电路

当地址输入到译码器中，译码器确定了存储单元地址然后读/写进CPU的过程如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803165551433.png" alt="image-20240803165551433" style="zoom: 50%;" />

**（2）重合法，双译码结构**

重合法将给出的地址拆成了两个组，一组是行地址，一组是列地址，行地址得到的行选择线和列地址得到的列选择线重合的存储单元就是需要读写的单元

假设有一个1K*1位的存储芯片如下所示，这里一位是一个存储元，也是读写的一个存储单元，采用32 * 32的方式进行排列：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803165903394.png" alt="image-20240803165903394" style="zoom:67%;" />

同样是1024个存储单元，所以地址线的数量应该是10根；有32行，所以行地址译码器分配5根地址线，输出32根行选择线，对应32套驱动电路；有32列，所以列地址译码器分配5根地址线，输出32根列选择线，对应32套驱动电路

所以总的驱动电路就是64套，译码选择过程如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803170354136.png" alt="image-20240803170354136" style="zoom:50%;" />

## 3.2.2 主存储器的性能指标

### 存储容量

也就是主存可以容纳的存储单元的个数

如果按字编址，那么一个存储单元就是一个字，存储容量就是：存储单元个数 * 存储字长，单位是位(b)，这里存储字长一般等于机器字长

如果按字节编址，那么一个存储单元就是一个字节，存储容量就是存储单元个数，即存放的字节数，单位是字节(B)

需要注意的是，如果按字编址的话存储容量的写法得用存储单元个数 * 存储字长的写法，如果按字节编址就直接写成字节数；这样做是因为存储字长在不同的机器上是不一样的，统一用位表示，并且写成乘积的形式容易理解，而字节则是一个统一的单位

存储单位换算如下：

```c
1 TB = 1K GB
1GB = 1K MB
1MB = 1K KB
1KB = 1K B
1B = 8b
上述1K表示1024，即2^(10)
```

### 存储速度（读写速度）

通常用存取时间和存取周期表示

存取时间称为存储器的访问时间，就是指启动一次存储器写（或读）到完成该操作的时间

读出时间是存储器受到有效地址，到产生有效输出的时间

写入时间是存储器收到有效地址，到写入存储单元的时间；通常写入时间和读出时间相等，两者统称为存储器的读写时间

存取周期是指存储器完成一个完整的读写所需要的时间，其包括读写时间以及后面的电路恢复时间，它是一个更加完整的过程，因此其时间略大于读写时间

### 存储器带宽

指单位时间内存储器的存取信息量，单位为W/s, B/s, 或b/s，计算公式为：
$$
存储器带宽 = \frac{每个存储周期可访问的位数}{存取周期(s)}
$$
存储带宽就是以存储器为中心的计算机系统获取信息的速度，通常通过缩短存取周期，增加存储字长，增加存储体等方式增大带宽

## 3.2.3 SRAM

SRAM即静态随机存储器，其静态的意义就是只要保持电源供电，SRAM就能稳定保存数据，SRAM的基本特征是使用一个双稳态的触发器作为存储元

不是重点，略

### SRAM芯片举例

#### CY7C1011CV33 SRAM

这个芯片的存储容量为128K * 16位，结构如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803185900655.png" alt="image-20240803185900655" style="zoom:67%;" />

其包括$IO_0 - IO_7$的低字节数据线部分，以及$IO_8 - IO_{15}$的高字节数据线部分，用来将数据读出写入

以及片使能$\bar{CE}$，主存一般是由若干个上图的芯片组成的，因此每次访存涉及的芯片也不一样，这里的片使能为低电平有效，也就是上图中$\bar{CE}$对应的那条细线为低电平的时候表示本次存储器的访问涉及这个芯片

输出使能$\bar{OE}$，低电平有效，即表示$\bar{OE}$对应的那根细线为低电平的时候是从存储器中读取数据

写使能$\bar{WE}$，低电平有效，即表示$\bar{WE}$对应的那根细线为低电平的时候是从存储器中写入数据

同样有高字节使能$\bar{BHE}$和低字节使能$\bar{BLE}$，分别表示要访问一个字中的高字节还是低字节

当$\bar{CE}$和$\bar{WE}$均为低电平的时候，数据线上的数据被写入存储单元，当$\bar{CE}$和$\bar{OE}$均为低电平的时候，存储单元上的数据被读出

一般这样一个芯片会使用一个逻辑符号框图表示：

![image-20240803190836533](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803190836533.png)

这个框图的内部写上芯片名字以及片容量，还有在对应的引脚处写上引端名字，引端名字是芯片引脚的逻辑定义，是由厂家给出的

在方框的外部写上信号名字，这里的信号是用户自定义的，不过不管是引端名字还是信号名字，都指的是那根细线，而不是细线与圆圈组成的整体

当然，上述引脚线是逻辑引脚，当然还包括电气引脚，比如电源线和接地线等等，这里忽略



#### Intel 2114 SRAM

这个芯片的容量为1K * 4位，存储矩阵是64 * 64，结构如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803191341971.png" alt="image-20240803191341971" style="zoom:67%;" />

其地址译码采用的是重合法，$A_3 \sim A_8$是行地址，$A_9, A_2 \sim A_0$是列地址

其同样有一个片选信号，是低使能有效

控制读写的只有一个写使能信号，同样是低使能有效，表示低使能写信号有效，表示写入数据

其逻辑框图如下所示：

<img src="https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803191618280.png" alt="image-20240803191618280" style="zoom: 50%;" />

### SRAM的读写时序

对于一个确定的芯片而言其读写时序是确定的，这里以CY7C1011CV33 SRAM为例

**（1）其读数据的信号如下所示：**

![image-20240803194046108](https://typora-1310242472.cos.ap-nanjing.myqcloud.com/typora_img/image-20240803194046108.png)

上图中的地址线和数据线两根的原因是输入一串数据中有0也有1，这里变化一次表示有效无效的变化

首先是CPU在地址总线上发出有效地址，并且通过片选信号$\bar{CE}$选中这块芯片，如上图中的橙色线所示，此时存储器对地址信号进行译码并选中相应的存储单元

经过一段时间后，读使能信号和高低字节使能信号有效，如上图中的紫色直线，并经过一段延迟时间后数据有效输出相应的高低字节，上图红色线

读出过程中存在两个约束：

（1）从发出使能信号$\bar{CE}$橙色线，到数据有效真正读到数据上图红色线，注意是红色线，原图有误，需要经过一个时间tace

（2）从读使能有效紫色，到数据真正有效红色，同样有一个时间tdoe

tace的时间最短是10ns，因此如果cpu发出了使能有效后真正读到数据就得10ns之后了

并且撤销过程也有两个约束：

（1）从撤销使能信号$\bar{CE}$蓝色，到数据线上的数据无效有一个时间延迟thzce

（2）从撤销读使能信号$\bar{OE}$到数据上上数据无效（撤销数据）有一个时间延迟thzoe

这就说明CPU发出了撤销信号之后数据真正从数据线上撤销还需要有一个时延，在这个时延中数据线仍被占用不能被其他数据使用，所以从发出使用这个存储器的信号开始（橙色）到这个存储器真正可以被再次使用（绿色）这一段时间trc + thzce是这个存储器的恢复时间

从片使能信号发出，到片使能信号结束的时间trc，为存储器芯片的读出时间

只要不违反上述两个约束就可以随意使用这个芯片，比如可以让$\bar{CE}$和${\bar{OE}}$同时有效，然后等tace的时间读到数据

**（2）其写入时序如下所示：**

